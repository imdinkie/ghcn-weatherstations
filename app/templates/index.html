{% extends "base.html" %}

{% block title %}Stationssuche{% endblock %}

{% block head_extra %}
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
{% endblock %}

{% block content %}
  <div class="layout">
    <section class="main">
      <h1 class="page-title">Stationssuche</h1>
      <p class="muted page-subtitle">
        Koordinaten eingeben → Stationen im Radius finden → Station auf der Karte auswählen.
      </p>

      {% if stations and stations|length > 0 %}
        <div class="card">
          <div id="map" class="map" aria-label="Karte mit Stationen"></div>
          <p class="muted">Tipp: Marker anklicken oder Tabellenzeile wählen.</p>
        </div>

        <div class="card table-wrap">
          <table class="table-clickable" id="results-table">
            <thead>
              <tr>
                <th>Station</th>
                <th>Distanz</th>
                <th>TMIN Jahre</th>
                <th>TMAX Jahre</th>
              </tr>
            </thead>
            <tbody>
              {% for s in stations %}
                {% set station_url = "/ui/stations/" ~ s.id ~ "?lat=" ~ defaults.lat ~ "&lon=" ~ defaults.lon ~ "&radius_km=" ~ defaults.radius_km ~ "&limit=" ~ defaults.limit ~ "&start_year=" ~ (defaults.start_year if defaults.start_year else "") ~ "&end_year=" ~ (defaults.end_year if defaults.end_year else "") %}
                <tr class="row-link" tabindex="0" role="link" data-href="{{ station_url }}">
                  <td>
                    <div class="strong">{{ s.name }}</div>
                    <div class="muted">{{ s.id }} · {{ '%.4f'|format(s.lat) }}, {{ '%.4f'|format(s.lon) }}</div>
                  </td>
                  <td>{{ '%.1f'|format(s.dist_km) }} km</td>
                  <td>{{ s.tmin_first_year if s.tmin_first_year else '—' }}–{{ s.tmin_last_year if s.tmin_last_year else '—' }}</td>
                  <td>{{ s.tmax_first_year if s.tmax_first_year else '—' }}–{{ s.tmax_last_year if s.tmax_last_year else '—' }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="card">
          <p class="muted">
            Gib rechts deine Parameter ein und klicke <strong>Suchen</strong>. Dann erscheinen Karte und Trefferliste hier.
          </p>
        </div>
      {% endif %}

      <p class="muted">
        API-Docs: <a href="/docs">/docs</a>
      </p>
    </section>

    <aside class="sidebar">
      <form class="card" method="get" action="/" id="search-form" novalidate>
        <label>Latitude
          <input name="lat" id="lat" type="number" step="any" min="-90" max="90" required value="{{ defaults.lat }}" />
          <div class="field-error" id="err-lat"></div>
        </label>
        <label>Longitude
          <input name="lon" id="lon" type="number" step="any" min="-180" max="180" required value="{{ defaults.lon }}" />
          <div class="field-error" id="err-lon"></div>
        </label>
        <label>Radius (km)
          <input name="radius_km" id="radius_km" type="number" step="any" min="1" max="2000" required value="{{ defaults.radius_km }}" />
          <div class="field-error" id="err-radius_km"></div>
        </label>
        <label>Limit
          <input name="limit" id="limit" type="number" step="1" min="1" max="200" required value="{{ defaults.limit }}" />
          <div class="field-error" id="err-limit"></div>
        </label>
        <label>Startjahr (optional)
          <input name="start_year" id="start_year" type="number" step="1" min="1700" max="{{ max_year }}" value="{{ defaults.start_year }}" />
          <div class="field-error" id="err-start_year"></div>
        </label>
        <label>Endjahr (optional)
          <input name="end_year" id="end_year" type="number" step="1" min="1700" max="{{ max_year }}" value="{{ defaults.end_year }}" />
          <div class="field-error" id="err-end_year"></div>
        </label>

        <div class="row">
          <button type="submit" id="search-btn">Suchen</button>
          <span class="muted">Tipp: Import vorher ausführen, sonst ist die DB leer.</span>
        </div>
      </form>
    </aside>
  </div>
{% endblock %}

{% block scripts %}
  <script id="stations-json" type="application/json">{{ stations_json | safe }}</script>
  <script id="params-json" type="application/json">{{ params_json | safe }}</script>
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script>
    (function () {
      const form = document.getElementById("search-form");
      const btn = document.getElementById("search-btn");
      const maxYear = Number("{{ max_year }}");

      const lat = document.getElementById("lat");
      const lon = document.getElementById("lon");
      const radius = document.getElementById("radius_km");
      const limit = document.getElementById("limit");
      const startYear = document.getElementById("start_year");
      const endYear = document.getElementById("end_year");

      const err = {
        lat: document.getElementById("err-lat"),
        lon: document.getElementById("err-lon"),
        radius_km: document.getElementById("err-radius_km"),
        limit: document.getElementById("err-limit"),
        start_year: document.getElementById("err-start_year"),
        end_year: document.getElementById("err-end_year"),
      };

      function setError(input, key, message) {
        input.setCustomValidity(message || "");
        err[key].textContent = message || "";
      }

      function numOrNull(input) {
        const v = input.value.trim();
        if (v === "") return null;
        const n = Number(v);
        return Number.isFinite(n) ? n : NaN;
      }

      function validate() {
        const latV = numOrNull(lat);
        const lonV = numOrNull(lon);
        const radiusV = numOrNull(radius);
        const limitV = numOrNull(limit);
        const startV = numOrNull(startYear);
        const endV = numOrNull(endYear);

        setError(lat, "lat", "");
        setError(lon, "lon", "");
        setError(radius, "radius_km", "");
        setError(limit, "limit", "");
        setError(startYear, "start_year", "");
        setError(endYear, "end_year", "");

        if (latV === null || Number.isNaN(latV)) setError(lat, "lat", "Bitte Latitude eingeben.");
        else if (latV < -90 || latV > 90) setError(lat, "lat", "Latitude muss zwischen -90 und 90 liegen.");

        if (lonV === null || Number.isNaN(lonV)) setError(lon, "lon", "Bitte Longitude eingeben.");
        else if (lonV < -180 || lonV > 180) setError(lon, "lon", "Longitude muss zwischen -180 und 180 liegen.");

        if (radiusV === null || Number.isNaN(radiusV)) setError(radius, "radius_km", "Bitte Radius eingeben.");
        else if (radiusV < 1 || radiusV > 2000) setError(radius, "radius_km", "Radius muss zwischen 1 und 2000 km liegen.");

        if (limitV === null || Number.isNaN(limitV)) setError(limit, "limit", "Bitte Limit eingeben.");
        else if (!Number.isInteger(limitV)) setError(limit, "limit", "Limit muss eine ganze Zahl sein.");
        else if (limitV < 1 || limitV > 200) setError(limit, "limit", "Limit muss zwischen 1 und 200 liegen.");

        if (startV !== null) {
          if (Number.isNaN(startV)) setError(startYear, "start_year", "Startjahr muss eine Zahl sein.");
          else if (!Number.isInteger(startV)) setError(startYear, "start_year", "Startjahr muss eine ganze Zahl sein.");
          else if (startV < 1700 || startV > maxYear) setError(startYear, "start_year", `Startjahr muss zwischen 1700 und ${maxYear} liegen.`);
        }
        if (endV !== null) {
          if (Number.isNaN(endV)) setError(endYear, "end_year", "Endjahr muss eine Zahl sein.");
          else if (!Number.isInteger(endV)) setError(endYear, "end_year", "Endjahr muss eine ganze Zahl sein.");
          else if (endV < 1700 || endV > maxYear) setError(endYear, "end_year", `Endjahr muss zwischen 1700 und ${maxYear} liegen.`);
        }

        if (startV !== null && endV !== null && !Number.isNaN(startV) && !Number.isNaN(endV) && startV > endV) {
          setError(endYear, "end_year", "Endjahr muss >= Startjahr sein.");
        }

        btn.disabled = !form.checkValidity();
      }

      [lat, lon, radius, limit, startYear, endYear].forEach((el) => {
        el.addEventListener("input", validate);
        el.addEventListener("blur", validate);
      });

      form.addEventListener("submit", (e) => {
        validate();
        if (!form.checkValidity()) {
          e.preventDefault();
          form.reportValidity();
        }
      });

      validate();
    })();
  </script>

  <script>
    (function () {
      const mapEl = document.getElementById("map");
      if (!mapEl) return;

      const stations = JSON.parse(document.getElementById("stations-json").textContent || "[]");
      const params = JSON.parse(document.getElementById("params-json").textContent || "{}");

      const center = { lat: Number(params.lat), lon: Number(params.lon) };
      const radiusKm = Number(params.radius_km);
      const limit = Number(params.limit);
      const startYear = params.start_year == null ? "" : String(params.start_year);
      const endYear = params.end_year == null ? "" : String(params.end_year);

      const map = L.map("map", { scrollWheelZoom: false });
      L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap',
      }).addTo(map);

      map.createPane("centerPane");
      map.getPane("centerPane").style.zIndex = 650;

      const centerLatLng = L.latLng(center.lat, center.lon);
      map.setView(centerLatLng, 10);
      const centerMarker = L.circleMarker(centerLatLng, {
        pane: "centerPane",
        radius: 9,
        color: "#7f1d1d",
        weight: 3,
        fillColor: "#ef4444",
        fillOpacity: 1,
        opacity: 1,
      }).addTo(map);
      centerMarker.bringToFront();
      L.circle(centerLatLng, {
        radius: radiusKm * 1000,
        color: "#2563eb",
        weight: 2,
        fillOpacity: 0.05,
      }).addTo(map);

      const bounds = L.latLngBounds([centerLatLng]);
      for (const s of stations) {
        const ll = L.latLng(s.lat, s.lon);
        bounds.extend(ll);

        const url = `/ui/stations/${encodeURIComponent(s.id)}?lat=${encodeURIComponent(center.lat)}&lon=${encodeURIComponent(center.lon)}&radius_km=${encodeURIComponent(radiusKm)}&limit=${encodeURIComponent(limit)}&start_year=${encodeURIComponent(startYear)}&end_year=${encodeURIComponent(endYear)}`;
        const popup = `
          <div>
            <div style="font-weight:700">${escapeHtml(s.name)}</div>
            <div style="color:#666;font-size:12px">${s.id} · ${Number(s.dist_km).toFixed(1)} km</div>
            <div style="margin-top:6px"><a href="${url}">Station öffnen</a></div>
          </div>
        `;
        L.marker(ll, { title: s.id }).addTo(map).bindPopup(popup);
      }

      if (stations.length > 0) {
        map.fitBounds(bounds.pad(0.2));
      }

      function escapeHtml(str) {
        return String(str).replace(/[&<>"']/g, (ch) => ({
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#39;",
        }[ch]));
      }

      const table = document.getElementById("results-table");
      if (table) {
        for (const row of table.querySelectorAll("tbody tr.row-link")) {
          row.addEventListener("click", () => {
            window.location.href = row.dataset.href;
          });
          row.addEventListener("keydown", (ev) => {
            if (ev.key === "Enter" || ev.key === " ") {
              ev.preventDefault();
              window.location.href = row.dataset.href;
            }
          });
        }
      }
    })();
  </script>
{% endblock %}
