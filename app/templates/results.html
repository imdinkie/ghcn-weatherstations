{% extends "base.html" %}

{% block title %}Suchergebnisse{% endblock %}

{% block head_extra %}
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
{% endblock %}

{% block content %}
  <a href="/">← zurück</a>
  <h1>Suchergebnisse</h1>
  <p class="muted">
    Standpunkt: {{ '%.4f'|format(params.lat) }}, {{ '%.4f'|format(params.lon) }}
    · Radius: {{ params.radius_km }} km
    · Limit: {{ params.limit }}
    {% if params.start_year or params.end_year %}
      · Jahre:
      {{ params.start_year if params.start_year else '—' }}–{{ params.end_year if params.end_year else '—' }}
    {% endif %}
  </p>

  {% if not stations %}
    <div class="card">
      <p>Keine Stationen gefunden (oder DB leer).</p>
      <p class="muted">Prüfe: Metadaten importiert? Filter zu streng? Radius zu klein?</p>
    </div>
  {% else %}
    <p class="muted">{{ stations|length }} Treffer (sortiert nach Distanz).</p>

    <div class="card">
      <div id="map" class="map" aria-label="Karte mit Stationen"></div>
      <p class="muted">
        Tipp: Marker anklicken, um die Station zu öffnen.
      </p>
    </div>

    <div class="card table-wrap">
      <table>
        <thead>
          <tr>
            <th>Station</th>
            <th>Distanz</th>
            <th>TMIN Jahre</th>
            <th>TMAX Jahre</th>
            <th>Öffnen</th>
          </tr>
        </thead>
        <tbody>
          {% for s in stations %}
            <tr>
              <td>
                <div class="strong">{{ s.name }}</div>
                <div class="muted">{{ s.id }} · {{ '%.4f'|format(s.lat) }}, {{ '%.4f'|format(s.lon) }}</div>
              </td>
              <td>{{ '%.1f'|format(s.dist_km) }} km</td>
              <td>{{ s.tmin_first_year if s.tmin_first_year else '—' }}–{{ s.tmin_last_year if s.tmin_last_year else '—' }}</td>
              <td>{{ s.tmax_first_year if s.tmax_first_year else '—' }}–{{ s.tmax_last_year if s.tmax_last_year else '—' }}</td>
              <td>
                <a href="/ui/stations/{{ s.id }}?start_year={{ params.start_year if params.start_year else '' }}&end_year={{ params.end_year if params.end_year else '' }}">Auswählen</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}
{% endblock %}

{% block scripts %}
  <script id="stations-json" type="application/json">{{ stations_json | safe }}</script>
  <script id="params-json" type="application/json">{{ params_json | safe }}</script>
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script>
    (function () {
      const stations = JSON.parse(document.getElementById("stations-json").textContent || "[]");
      const params = JSON.parse(document.getElementById("params-json").textContent || "{}");

      const center = { lat: Number(params.lat), lon: Number(params.lon) };
      const radiusKm = Number(params.radius_km);
      const startYear = params.start_year == null ? "" : String(params.start_year);
      const endYear = params.end_year == null ? "" : String(params.end_year);

      const map = L.map("map", { scrollWheelZoom: false });
      L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap',
      }).addTo(map);

      map.createPane("centerPane");
      map.getPane("centerPane").style.zIndex = 650;

      const centerLatLng = L.latLng(center.lat, center.lon);
      map.setView(centerLatLng, 10);
      const centerMarker = L.circleMarker(centerLatLng, {
        pane: "centerPane",
        radius: 9,
        color: "#7f1d1d",
        weight: 3,
        fillColor: "#ef4444",
        fillOpacity: 1,
        opacity: 1,
      }).addTo(map);
      centerMarker.bindTooltip("Standpunkt", { permanent: false });
      centerMarker.bringToFront();
      L.circle(centerLatLng, {
        radius: radiusKm * 1000,
        color: "#2563eb",
        weight: 2,
        fillOpacity: 0.05,
      }).addTo(map);

      const bounds = L.latLngBounds([centerLatLng]);
      for (const s of stations) {
        const ll = L.latLng(s.lat, s.lon);
        bounds.extend(ll);

        const url = `/ui/stations/${encodeURIComponent(s.id)}?start_year=${encodeURIComponent(startYear)}&end_year=${encodeURIComponent(endYear)}`;
        const popup = `
          <div>
            <div style="font-weight:700">${escapeHtml(s.name)}</div>
            <div style="color:#666;font-size:12px">${s.id} · ${Number(s.dist_km).toFixed(1)} km</div>
            <div style="margin-top:6px"><a href="${url}">Station öffnen</a></div>
          </div>
        `;
        L.marker(ll, { title: s.id }).addTo(map).bindPopup(popup);
      }

      if (stations.length > 0) {
        map.fitBounds(bounds.pad(0.2));
      } else {
        map.setView(centerLatLng, 8);
      }

      function escapeHtml(str) {
        return String(str).replace(/[&<>"']/g, (ch) => ({
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#39;",
        }[ch]));
      }
    })();
  </script>
{% endblock %}
